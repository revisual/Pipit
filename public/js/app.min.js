"use strict";!function(a){var b=a.module("angular-progress-arc",[]);b.provider("progressArcDefaults",function(){var b={size:200,strokeWidth:20,stroke:"black",background:null};this.setDefault=function(a,c){return b[a]=c,this},this.$get=function(){return function(c){a.forEach(b,function(a,b){c[b]||(c[b]=a)})}}}),b.directive("progressArc",["progressArcDefaults",function(a){return{restrict:"E",scope:{size:"@",strokeWidth:"@",stroke:"@",counterClockwise:"@",complete:"&",background:"@"},compile:function(b,c){return a(c),function(a,b,c){a.offset=/firefox/i.test(navigator.userAgent)?-89.9:-90;var d=function(){a.strokeWidthCapped=Math.min(a.strokeWidth,a.size/2-1),a.radius=Math.max((a.size-a.strokeWidthCapped)/2-1,0),a.circumference=2*Math.PI*a.radius};a.$watchCollection("[size, strokeWidth]",d),d()}},template:'<svg ng-attr-width="{{size}}" ng-attr-height="{{size}}"><circle fill="none" ng-if="background" ng-attr-cx="{{size/2}}" ng-attr-cy="{{size/2}}" ng-attr-r="{{radius}}" ng-attr-stroke="{{background}}" ng-attr-stroke-width="{{strokeWidthCapped}}"/><circle fill="none" ng-attr-cx="{{size/2}}" ng-attr-cy="{{size/2}}" ng-attr-r="{{radius}}" ng-attr-stroke="{{stroke}}" ng-attr-stroke-width="{{strokeWidthCapped}}"ng-attr-stroke-dasharray="{{circumference}}"ng-attr-stroke-dashoffset="{{(1 - complete()) * circumference}}"ng-attr-transform="rotate({{offset}}, {{size/2}}, {{size/2}})'+"{{ (counterClockwise && counterClockwise != 'false') ? ' translate(0, ' + size + ') scale(1, -1)' : '' }}\"/></svg>"}}])}(window.angular),angular.module("app.services",[]).factory("windowService",["$window",function(a){var b=new signals.Signal,c={resize:b,width:a.innerWidth,height:a.innerHeight,hasTouch:function(){return"ontouchstart"in a}};return a.onresize=function(d){c.width=a.innerWidth,c.height=a.innerHeight,b.dispatch(c.width,c.height)},c}]).factory("imageSize",["windowService",function(a){var b=[768,992,1200],c=[768,992,1200,992];return{getValue:function(){var d=a.width,e=0;do{if(d<b[e])return c[e];e++}while(e<b.length);return c[c.length-1]}}}]).factory("API",["$http","imageSize",function(a,b){return{getBook:function(c,d){return a.get("/api-book/"+c+"/"+d+"/"+b.getValue()+"/").then(function(a){return a.data})},getProject:function(b){var c="";for(var d in b)""!=c&&(c+="&"),c+=d+"="+b[d];return""!=c&&(c="?"+c),a.get("/api-project/"+c).then(function(a){return a.data})}}}]).factory("BookService",["$location","animationFrame","API","imageService","Settings",function(a,b,c,d,e){var f,g,h={baseURL:null,overlayURL:null,overlayOpacity:-1},i=new signals.Signal,j={page:0,remainder:0},k={isComplete:function(){var a=Math.round(1e3*this.currentValue),b=Math.round(1e3*this.targetValue);return a===b},reset:function(){this.currentValue=0,this.targetValue=0,this.baseURL=null,this.overlayURL=null,this.overlayOpacity=-1},backToBase:function(){this.targetValue=this.currentValue},currentValue:0,targetValue:0,baseURL:null,overlayURL:null,overlayOpacity:-1},l=!1,m=function(){g=setTimeout(function(){f&&(b(m),i.dispatch(q))},33)},n=function(){l=!1,f?k.backToBase():(f=!0,m())},o=function(){l=!0};f=!0;var p=function(){f=!1,l=!1,clearTimeout(g)},q=function(a){if(isNaN(a))return h;var b=k.targetValue+a;b>0&&1>b&&(k.targetValue+=a),r();var c=j.page+1,e=d.images[j.page].src;c>=d.images.length&&(c=j.page);var f=d.images[c].src;return k.baseURL=k.baseURL==e?null:e,k.overlayURL=k.overlayURL==f?null:f,k.overlayOpacity=j.remainder,l&&k.isComplete()&&p(),k},r=function(){k.currentValue+=(k.targetValue-k.currentValue)*e.drag;var a=k.currentValue*d.totalNumberImages;j.page=Math.floor(a),j.remainder=a-j.page},s=function(){var b=a.search();c.getBook(b.project,b.book).then(function(a){d.resetWith(a.book.imageURLs),d.start()})},t=function(){p(),k.reset(),d.on.removeAll(),i.removeAll()};return{resolve:d.on.resolve,progress:d.on.progress,complete:d.on.complete,start:n,tick:i,end:o,load:s,reset:t}}]).factory("Settings",function(){return{fullscreen:!1,sensitivity:4,sensitivitySliderValues:{min:.5,max:10,step:.5},drag:.5,dragSliderValues:{min:.1,max:1,step:.1},imageSize:110,imageSizeSliderValues:{min:50,max:110,step:1},getImageSizeAsCSS:function(){return this.imageSize<100?this.imageSize+"%":this.imageSize<110?"contains":"cover"}}}).value("imageService",new ImageListLoader),function(a){var b=a.module("angular-animation-frame",[]);b.factory("animationFrame",["$window",function(a){return function(){for(var b=0,c=["ms","moz","webkit","o"],d=0;d<c.length&&!a.requestAnimationFrame;++d)a.requestAnimationFrame=a[c[d]+"RequestAnimationFrame"],a.cancelAnimationFrame=a[c[d]+"CancelAnimationFrame"]||a[c[d]+"CancelRequestAnimationFrame"];a.requestAnimationFrame||(a.requestAnimationFrame=function(c,d){var e=(new Date).getTime(),f=Math.max(0,16-(e-b)),g=a.setTimeout(function(){c(e+f)},f);return b=e+f,g}),a.cancelAnimationFrame||(a.cancelAnimationFrame=function(a){clearTimeout(a)})}(),a.requestAnimationFrame}])}(window.angular),function(a){var b=function(a){var b=a.module("FBAngular",[]);return b.factory("Fullscreen",["$document","$rootScope",function(b,c){var d=b[0],e="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element&&Element.ALLOW_KEYBOARD_INPUT,f=c.$new();b.on("fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange",function(){f.$emit("FBFullscreen.change",g.isEnabled())});var g={$on:a.bind(f,f.$on),all:function(){g.enable(d.documentElement)},enable:function(a){a.requestFullScreen?a.requestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen?/Version\/[\d]{1,2}(\.[\d]{1,2}){1}(\.(\d){1,2}){0,1} Safari/.test(navigator.userAgent)?a.webkitRequestFullscreen():a.webkitRequestFullscreen(e):a.msRequestFullscreen&&a.msRequestFullscreen()},cancel:function(){d.cancelFullScreen?d.cancelFullScreen():d.mozCancelFullScreen?d.mozCancelFullScreen():d.webkitExitFullscreen?d.webkitExitFullscreen():d.msExitFullscreen&&d.msExitFullscreen()},isEnabled:function(){var a=d.fullscreenElement||d.mozFullScreenElement||d.webkitFullscreenElement||d.msFullscreenElement;return a?!0:!1},toggleAll:function(){g.isEnabled()?g.cancel():g.all()},isSupported:function(){var a=d.documentElement,b=a.requestFullScreen||a.mozRequestFullScreen||a.webkitRequestFullscreen||a.msRequestFullscreen;return b?!0:!1}};return g}]),b.directive("fullscreen",["Fullscreen",function(a){return{link:function(b,c,d){if(d.fullscreen){b.$watch(d.fullscreen,function(b){var d=a.isEnabled();b&&!d?(a.enable(c[0]),c.addClass("isInFullScreen")):!b&&d&&(a.cancel(),c.removeClass("isInFullScreen"))});var e=a.$on("FBFullscreen.change",function(a,e){e||b.$evalAsync(function(){b.$eval(d.fullscreen+"= false"),c.removeClass("isInFullScreen")})});b.$on("$destroy",function(){e()})}else{if(void 0!==d.onlyWatchedProperty)return;c.on("click",function(b){a.enable(c[0])})}}}}]),b};"function"==typeof define&&define.amd?define("FBAngular",["angular"],function(a){return b(a)}):b(a.angular)}(window);var module=angular.module("app.controllers",[]);module.controller("MenuCtrl",["$scope","$location","API",function(a,b,c){var d=b.search();a.partial=void 0===d.partial?"partials/default.html":"partials/"+d.partial+".html",c.getProject(d).then(function(b){a.projects=b.projects})}]),module.controller("FullScreenCtrl",["$scope","Fullscreen","Settings",function(a,b,c){a.toggle=function(){b.isEnabled()?(b.cancel(),c.fullscreen=!1):(b.all(),c.fullscreen=!0),a.fullscreen=c.fullscreen},a.fullscreen=c.fullscreen,a.toggle=function(){b.isEnabled()?(b.cancel(),c.fullscreen=!1):(b.all(),c.fullscreen=!0),a.fullscreen=c.fullscreen},a.fullscreen=c.fullscreen}]),module.controller("ToolBarCtrl",["$scope","Settings","WindowService",function(a,b,c){a.hasTouch=c.hasTouch(),a.enabled=!0,a.$watch("imageSize",function(){b.imageSize=a.imageSize,a.$emit("imageSize",b.getImageSizeAsCSS())}),a.$watch("sensitivity",function(){b.sensitivity=a.sensitivity}),a.$watch("drag",function(){b.drag=a.drag}),a.imageSize=b.imageSize,a.imageSizeSliderValues=b.imageSizeSliderValues,a.sensitivity=b.sensitivity,a.sensitivitySliderValues=b.sensitivitySliderValues,a.drag=b.drag,a.dragSliderValues=b.dragSliderValues}]),module.controller("BookCtrl",["$scope","BookService","Settings","WindowService",function(a,b,c,d){b.reset(),a.hasTouch=d.hasTouch(),b.progress.add(function(b,c){a.$apply(function(){a.progress=b/c})}),b.resolve.addOnce(function(b){a.imageOverlay.setBottomImage(b.src),a.showBook=!0,a.showProgress=!0}),b.complete.addOnce(function(){a.$apply(function(){a.showProgress=!1,a.enabled=!0})}),b.tick.add(function(b){var e=b(a.trackPad.normalise(d.width/c.sensitivity,1).distFromLastX),f=a.imageOverlay;f.setBottomImage(e.baseURL),f.setTopImage(e.overlayURL,e.overlayOpacity)}),b.load(),a.$watch("active",function(){a.active?b.start():b.end()}),a.$on("imageSize",function(b,c){var d=a.imageOverlay;d.setBottomImage(null,-1,c),d.setTopImage(null,-1,c)})}]),function(a){var b=a.module("angular-slider",[]);b.directive("sliderControl",["$swipe",function(a){return{restrict:"E",require:"?ngModel",template:'<div id="fill" class="fill"></div><div id="thumb" class="thumb"></div>',link:function(b,c,d,e){function f(a){a.preventDefault(),i({x:a.clientX,y:a.clientY}),c.on("mousemove",g),c.on("mouseup",h)}function g(a){k({x:a.clientX,y:a.clientY})}function h(){c.unbind("mousemove",g),c.unbind("mouseup",h),j()}function i(a){s=p.prop("offsetLeft"),t=a.x}function j(a){}function k(a){var b=a.x-t,c=s+b;c>q-r?c=q-r:0>c&&(c=0),p.css({left:c+"px"}),o.css({width:q-(q-c-r)+"px"}),l(c)}function l(a){var b=void 0==d.max?100:parseFloat(d.max),c=void 0==d.min?0:parseFloat(d.min),e=void 0==d.increment?1:parseFloat(d.increment),f=a/(q-r),g=(b-c)*f+c,h=g-g%e;h!=u&&(x(h),u=h)}var m="true"==d.touchEnabled,n=!1,o=c.children().eq(0),p=c.children().eq(1);o.css({position:"absolute",height:"inherit"}),p.css({position:"absolute",height:"inherit"});var q=c[0].offsetWidth,r=p[0].offsetWidth,s=0,t=0,u=0;d.$observe("enabled",function(a){"true"==a?v():w()});var v=function(){n||(n=!0,m?a.bind(c,{start:i,move:k,end:j,cancel:j}):(b.swipe=!1,c.on("mousedown",f)))},w=function(){n&&(n=!1,m?a.unbind(c,{start:i,move:k,end:j,cancel:j}):(c.off("mousedown",f),c.off("mousemove",g),c.off("mouseup",h)))};e.$render=function(){var a=void 0==d.max?100:parseFloat(d.max),b=void 0==d.min?0:parseFloat(d.min);e.$viewValue<b?e.$viewValue=b:e.$viewValue>a&&(e.$viewValue=a);var c=(e.$viewValue-b)/(a-b),f=(q-r)*c;p.css({left:f+"px"}),o.css({width:q-(q-f-r)+"px"})};var x=function(a){b.disabled||b.$apply(function(){e.$setViewValue(a)})}}}}])}(window.angular),angular.module("app.directives",[]).directive("trackPad",["$swipe",function(a){return{restrict:"E",link:function(b,c,d){function e(){n||(n=!0,m?a.bind(c,{start:j,move:l,end:k,cancel:k}):c.on("mousedown",g))}function f(){n&&(n=!1,m?a.unbind(c,{start:j,move:l,end:k,cancel:k}):(c.off("mousedown",g),c.off("mousemove",h),c.off("mouseup",i)))}function g(a){a.preventDefault(),j({x:a.screenX,y:a.screenY}),c.on("mousemove",h),c.on("mouseup",i)}function h(a){l({x:a.screenX,y:a.screenY})}function i(){c.unbind("mousemove",h),c.unbind("mouseup",i),k()}function j(a){b.$apply(function(){b.active=!0});var c=b.trackPad;c.previousPoint=a,c.distancePoint={x:0,y:0,mx:0,my:0}}function k(a){b.$apply(function(){b.active=!1})}function l(a){var c=b.trackPad;c.distancePoint.mx=a.x-c.previousPoint.mx,c.distancePoint.my=a.y-c.previousPoint.my,c.previousPoint.mx=a.x,c.previousPoint.my=a.y,c.distancePoint.x=a.x-c.previousPoint.x,c.distancePoint.y=a.y-c.previousPoint.y}var m="true"==d.touchEnabled,n=!1;b.active=!1,b.trackPad={previousPoint:{x:0,y:0},distancePoint:{x:0,y:0,mx:0,my:0},normalise:function(a,c){var d=b.trackPad;return{firstTouchX:d.previousPoint.x/a,firstTouchY:d.previousPoint.y/c,lastTouchX:d.previousPoint.mx/a,lastTouchY:d.previousPoint.my/c,distFromFirstX:d.distancePoint.x/a,distFromFirstY:d.distancePoint.y/c,distFromLastX:d.distancePoint.mx/a,distFromLastY:d.distancePoint.my/c}}},d.$observe("enabled",function(a){"true"==a?e():f()})}}}]).directive("imageOverlay",[function(){return{restrict:"E",link:function(a,b,c){function d(a){return a.charAt(0).toUpperCase()+a.slice(1)}void 0==a.imageOverlay&&(a.imageOverlay={}),a.imageOverlay["set"+d(c.id)+"Image"]=function(a,c,d){var e=!1,f={};null!=a&&""!=a&&(f["background-image"]="url("+a+")",e=!0),c>=0&&(f.opacity=c,e=!0),void 0!=d&&(f["background-size"]=d,e=!0),e&&b.css(f)}}}}]);var module=angular.module("app",["app.services","app.directives","app.controllers","ngRoute","ngTouch","ui.bootstrap","angular-progress-arc","FBAngular","angular-animation-frame","angular-slider"]);module.config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"partials/main-menu.html",controller:"MenuCtrl"}).when("/book",{templateUrl:"partials/book.html",controller:"BookCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode({enabled:!0,requireBase:!1})}]);