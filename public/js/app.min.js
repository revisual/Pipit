"use strict";!function(a){var b=a.module("angular-progress-arc",[]);b.provider("progressArcDefaults",function(){var b={size:200,strokeWidth:20,stroke:"black",background:null};this.setDefault=function(a,c){return b[a]=c,this},this.$get=function(){return function(c){a.forEach(b,function(a,b){c[b]||(c[b]=a)})}}}),b.directive("progressArc",["progressArcDefaults",function(a){return{restrict:"E",scope:{size:"@",strokeWidth:"@",stroke:"@",counterClockwise:"@",complete:"&",background:"@"},compile:function(b,c){return a(c),function(a,b,c){a.offset=/firefox/i.test(navigator.userAgent)?-89.9:-90;var d=function(){a.strokeWidthCapped=Math.min(a.strokeWidth,a.size/2-1),a.radius=Math.max((a.size-a.strokeWidthCapped)/2-1,0),a.circumference=2*Math.PI*a.radius};a.$watchCollection("[size, strokeWidth]",d),d()}},template:'<svg ng-attr-width="{{size}}" ng-attr-height="{{size}}"><circle fill="none" ng-if="background" ng-attr-cx="{{size/2}}" ng-attr-cy="{{size/2}}" ng-attr-r="{{radius}}" ng-attr-stroke="{{background}}" ng-attr-stroke-width="{{strokeWidthCapped}}"/><circle fill="none" ng-attr-cx="{{size/2}}" ng-attr-cy="{{size/2}}" ng-attr-r="{{radius}}" ng-attr-stroke="{{stroke}}" ng-attr-stroke-width="{{strokeWidthCapped}}"ng-attr-stroke-dasharray="{{circumference}}"ng-attr-stroke-dashoffset="{{(1 - complete()) * circumference}}"ng-attr-transform="rotate({{offset}}, {{size/2}}, {{size/2}})'+"{{ (counterClockwise && counterClockwise != 'false') ? ' translate(0, ' + size + ') scale(1, -1)' : '' }}\"/></svg>"}}])}(window.angular),angular.module("app.services",[]).factory("windowService",["$window",function(a){var b=new signals.Signal,c={resize:b,width:a.innerWidth,height:a.innerHeight,hasTouch:function(){return"ontouchstart"in a},back:function(){a.history.back()}};return a.onresize=function(d){c.width=a.innerWidth,c.height=a.innerHeight,b.dispatch(c.width,c.height)},c}]).factory("API",["$http",function(a){return{getBook:function(b,c){return a.get("/api/book?id="+b+"&size="+c).then(function(a){return a.data})},getProject:function(b){return a.get("/api/project?id="+b).then(function(a){return a.data})},getPresets:function(a){var b={items:[{imagesize:"auto",maxVel:.55,sensitivity:a?.55:.22,drag:.088,imageScale:150,interpolation:!0,killThreshold:10,deltaThrottle:22,fps:33}],success:!0};return Promise.resolve(b)},getProjectList:function(b){var c=b.projects;return c=void 0!=c?"?projects="+c:"/",a.get("/api/listProject"+c).then(function(a){return a.data})}}}]).factory("bookData",["Settings",function(a){return{isComplete:function(){var b=a.killThreshold,c=Math.round(this.currentValue*b),d=Math.round(this.targetValue*b);return c===d},reset:function(){this.totalPages=0,this.currentPage=0,this.currentValue=0,this.currentAlpha=0,this.targetValue=0,this.baseURL=null,this.overlayURL=null,this.overlayOpacity=-1},backToBase:function(){this.targetValue=this.currentValue},applyValue:function(b){this.targetValue+=b;var c=(this.targetValue-this.currentValue)*a.drag;this.currentValue+=Math.min(Math.max(c,-a.maxVel),a.maxVel),this.currentValue<0?this.currentValue=0:this.currentValue>this.totalPages-1&&(this.currentValue=this.totalPages-1);var d=this.currentValue;this.currentPage=Math.floor(d),this.currentAlpha=d-this.currentPage},applyUrls:function(a){var b=this.currentPage+1,c=a.images[this.currentPage].src;b>=a.images.length&&(b=this.currentPage);var d=a.images[b].src;this.baseURL=this.baseURL==c?null:c,this.overlayURL=this.overlayURL==d?null:d,this.overlayOpacity=this.currentAlpha},totalPages:0,currentPage:0,currentAlpha:0,currentValue:0,targetValue:0,baseURL:null,overlayURL:null,overlayOpacity:-1}}]).factory("BookService",["$location","animationFrame","bookData","API","imageService","Settings",function(a,b,c,d,e,f){var g,h,i={baseURL:null,overlayURL:null,overlayOpacity:-1},j=new signals.Signal,k=!1,l=function(){h=setTimeout(function(){g&&(b(l),j.dispatch(p))},f.fps)},m=function(){c.totalPages=e.totalNumberImages,k=!1,g?c.backToBase():(g=!0,l())},n=function(){k=!0},o=function(){g=!1,k=!1,clearTimeout(h)},p=function(a){return isNaN(a)?i:(c.applyValue(a),c.applyUrls(e),k&&c.isComplete()&&(console.log("KILL"),o()),c)},q=function(){var b=a.search();d.getBook(b.id||b.book,f.getImageSizeValue()).then(function(a){e.resetWith(a.book.imageURLs),e.start()})},r=function(){o(),c.reset(),e.reset(),j.removeAll()};return{resolve:e.on.resolve,progress:e.on.progress,complete:e.on.complete,data:c,start:m,tick:j,end:n,load:q,reset:r}}]).factory("Settings",["$cookies","windowService","API",function(a,b,c){var d={fps:40,imageSize:"xsmall",sizes:{xsmall:480,small:768,medium:992,large:1200,xlarge:1620,auto:"auto"},maxVel:.55,fullscreen:!1,sensitivity:.5,drag:.1,imageScale:110,interpolation:!0,killThreshold:10,deltaThrottle:33,current:1,items:[],changed:new signals.Signal,getImageSizeValue:function(){var a=this.sizes,c=this.imageSize,d=a[c];if("auto"==d){var e=b.width;if(e<=a.xsmall)return a.xsmall;if(e<=a.small)return a.small;if(e<=a.medium)return a.medium;if(e<=a.large)return a.large;if(e<=a.xlarge)return a.xlarge}return d},setFromCookie:function(){if(void 0!=a.preset){var b=parseInt(a.preset);this.current=b,this.setFromPreset(this.items[b])}},setFromPreset:function(a){if(null!=a){for(var b in d){var c=b.toLowerCase();a.hasOwnProperty(b)&&null!=a[b]?d[b]=a[b]:a.hasOwnProperty(c)&&null!=a[c]&&(d[b]=a[c])}d.changed.dispatch()}},getImageSizeAsCSS:function(){return this.imageScale<100?this.imageScale+"%":this.imageScale<110?"contains":"cover"},persist:function(){-1!=this.current&&(a.preset=this.current)},load:function(){return c.getPresets(b.hasTouch()).then(function(a){return a.success&&(d.items=a.items,d.changed.dispatch()),a})},setCurrent:function(a){var b=this.items.indexOf(a);-1!=a&&(this.current=b)}};return d}]).value("imageService",new ImageListLoader),function(a){var b=a.module("angular-animation-frame",[]);b.factory("animationFrame",["$window",function(a){return function(){for(var b=0,c=["ms","moz","webkit","o"],d=0;d<c.length&&!a.requestAnimationFrame;++d)a.requestAnimationFrame=a[c[d]+"RequestAnimationFrame"],a.cancelAnimationFrame=a[c[d]+"CancelAnimationFrame"]||a[c[d]+"CancelRequestAnimationFrame"];a.requestAnimationFrame||(a.requestAnimationFrame=function(c,d){var e=(new Date).getTime(),f=Math.max(0,16-(e-b)),g=a.setTimeout(function(){c(e+f)},f);return b=e+f,g}),a.cancelAnimationFrame||(a.cancelAnimationFrame=function(a){clearTimeout(a)})}(),a.requestAnimationFrame}])}(window.angular),function(a){var b=function(a){var b=a.module("FBAngular",[]);return b.factory("Fullscreen",["$document","$rootScope",function(b,c){var d=b[0],e="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element&&Element.ALLOW_KEYBOARD_INPUT,f=c.$new();b.on("fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange",function(){f.$emit("FBFullscreen.change",g.isEnabled())});var g={$on:a.bind(f,f.$on),all:function(){g.enable(d.documentElement)},enable:function(a){a.requestFullScreen?a.requestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen?/Version\/[\d]{1,2}(\.[\d]{1,2}){1}(\.(\d){1,2}){0,1} Safari/.test(navigator.userAgent)?a.webkitRequestFullscreen():a.webkitRequestFullscreen(e):a.msRequestFullscreen&&a.msRequestFullscreen()},cancel:function(){d.cancelFullScreen?d.cancelFullScreen():d.mozCancelFullScreen?d.mozCancelFullScreen():d.webkitExitFullscreen?d.webkitExitFullscreen():d.msExitFullscreen&&d.msExitFullscreen()},isEnabled:function(){var a=d.fullscreenElement||d.mozFullScreenElement||d.webkitFullscreenElement||d.msFullscreenElement;return a?!0:!1},toggleAll:function(){g.isEnabled()?g.cancel():g.all()},isSupported:function(){var a=d.documentElement,b=a.requestFullScreen||a.mozRequestFullScreen||a.webkitRequestFullscreen||a.msRequestFullscreen;return b?!0:!1}};return g}]),b.directive("fullscreen",["Fullscreen",function(a){return{link:function(b,c,d){if(d.fullscreen){b.$watch(d.fullscreen,function(b){var d=a.isEnabled();b&&!d?(a.enable(c[0]),c.addClass("isInFullScreen")):!b&&d&&(a.cancel(),c.removeClass("isInFullScreen"))});var e=a.$on("FBFullscreen.change",function(a,e){e||b.$evalAsync(function(){b.$eval(d.fullscreen+"= false"),c.removeClass("isInFullScreen")})});b.$on("$destroy",function(){e()})}else{if(void 0!==d.onlyWatchedProperty)return;c.on("click",function(b){a.enable(c[0])})}}}}]),b};"function"==typeof define&&define.amd?define("FBAngular",["angular"],function(a){return b(a)}):b(a.angular)}(window);var module=angular.module("app.controllers",[]);module.controller("MenuCtrl",["$scope","$location","API",function(a,b,c){var d=b.search();a.partial=void 0===d.partial?"partials/default.html":"partials/"+d.partial+".html",c.getProjectList(d).then(function(b){a.projects=b.projects})}]),module.controller("ProjectCtrl",["$scope","$location","API",function(a,b,c){var d=b.search();c.getProject(d.id).then(function(b){a.books=b.project.content,a.project=b.project})}]),module.controller("FullScreenCtrl",["$scope","windowService","Fullscreen","Settings",function(a,b,c,d){a.toggle=function(){c.isEnabled()?(c.cancel(),d.fullscreen=!1):(c.all(),d.fullscreen=!0),a.fullscreen=d.fullscreen},a.fullscreen=d.fullscreen,a.toggle=function(){c.isEnabled()?(c.cancel(),d.fullscreen=!1):(c.all(),d.fullscreen=!0),a.fullscreen=d.fullscreen},a.backToMenu=function(){b.back()},a.fullscreen=d.fullscreen}]),module.controller("ScrollCtrl",["$scope","BookService",function(a,b){var c=b.data;a.scrollProperties={ratio:1/c.totalPages,position:c.currentValue/(c.totalPages-1)},b.tick.add(function(b){a.$apply(function(){a.scrollProperties={ratio:1/c.totalPages,position:c.currentValue/(c.totalPages-1)}})})}]),module.controller("ImageSizeCtrl",["$scope","Settings",function(a,b){a.checkModel=b.sizes,a.radioModel=b.imageSize,a.$watch("radioModel",function(){b.imageSize=a.radioModel})}]),module.controller("BookCtrl",["$scope","BookService","Settings","windowService","$location",function(a,b,c,d){a.$on("$destroy",function(){b.reset(),b.on.removeAll()}),c.load().then(function(a){c.setFromPreset(c.items[0]),b.load()}),a.hasTouch=d.hasTouch(),b.progress.add(function(b,c){a.$apply(function(){a.progress=b/c})}),b.resolve.addOnce(function(b){a.imageOverlay.setBottomImage(b.src),a.showBook=!0,a.showProgress=!0,a.showDragInfo=!1}),b.complete.addOnce(function(){a.$apply(function(){a.showProgress=!1,a.enabled=!0,a.showDragInfo=!0})}),b.tick.add(function(b){var d=Math.min(Math.max(a.trackPad.distancePoint.mx,-c.deltaThrottle),c.deltaThrottle),e=d*c.sensitivity;e=isNaN(e)?0:e;var f=b(e),g=a.imageOverlay;g.setBottomImage(f.baseURL),c.interpolation?g.setTopImage(f.overlayURL,f.overlayOpacity):g.disableTopImage()}),a.$watch("active",function(){a.active?(a.showDragInfo&&(a.showDragInfo=!1),b.start()):b.end()}),a.$on("imageScale",function(b,c){var d=a.imageOverlay;d.setBottomImage(null,-1,c),d.setTopImage(null,-1,c)})}]),module.controller("CollapseCtrl",["$scope",function(a){a.isCollapsed=!0}]),function(a){var b=a.module("angular-scroll-indicator",[]);b.directive("scrollIndicator",[function(){return{restrict:"E",require:"?ngModel",template:'<div id="thumb" class="thumb"></div>',link:function(a,b,c,d){var e=b.children().eq(0);e.css({position:"absolute",height:"inherit"}),d.$render=function(){var a=d.$viewValue,c=a.ratio,f=a.position,g=b[0].offsetWidth,h=g*c;e.css({left:(g-h)*f+"px",width:h+"px"})}}}}])}(window.angular),function(a){var b=a.module("angular-slider",[]);b.directive("sliderControl",["$swipe",function(a){return{restrict:"E",require:"?ngModel",template:'<div id="fill" class="fill"></div><div id="thumb" class="thumb"></div>',link:function(b,c,d,e){function f(a){a.preventDefault(),i({x:a.clientX,y:a.clientY}),c.on("mousemove",g),c.on("mouseup",h),c.on("mouseout",h)}function g(a){k({x:a.clientX,y:a.clientY})}function h(){c.off("mousemove",g),c.off("mouseup",h),c.off("mouseout",h),j()}function i(a){s=p.prop("offsetLeft"),t=a.x}function j(a){}function k(a){var b=a.x-t,c=s+b;c>q-r?c=q-r:0>c&&(c=0),p.css({left:c+"px"}),o.css({width:q-(q-c-r)+"px"}),l(c)}function l(a){var b=void 0==d.max?100:parseFloat(d.max),c=void 0==d.min?0:parseFloat(d.min),e=void 0==d.increment?1:parseFloat(d.increment),f=a/(q-r),g=(b-c)*f+c,h=g-g%e;h!=u&&(x(h),u=h)}var m="true"==d.touchEnabled,n=!1,o=c.children().eq(0),p=c.children().eq(1);o.css({position:"absolute",height:"inherit"}),p.css({position:"absolute",height:"inherit"});var q=c[0].offsetWidth,r=p[0].offsetWidth,s=0,t=0,u=0;d.$observe("enabled",function(a){"true"==a?v():w()});var v=function(){n||(n=!0,m?a.bind(c,{start:i,move:k,end:j,cancel:j}):(b.swipe=!1,c.on("mousedown",f)))},w=function(){n&&(n=!1,m?a.unbind(c,{start:i,move:k,end:j,cancel:j}):(c.off("mousedown",f),c.off("mousemove",g),c.off("mouseup",h),c.off("mouseout",h)))};e.$render=function(){var a=void 0==d.max?100:parseFloat(d.max),b=void 0==d.min?0:parseFloat(d.min);e.$viewValue<b?e.$viewValue=b:e.$viewValue>a&&(e.$viewValue=a);var c=(e.$viewValue-b)/(a-b),f=(q-r)*c;p.css({left:f+"px"}),o.css({width:q-(q-f-r)+"px"})};var x=function(a){b.disabled||b.$apply(function(){e.$setViewValue(a)})}}}}])}(window.angular),angular.module("app.directives",[]).directive("trackPad",["$swipe",function(a){return{restrict:"E",link:function(b,c,d){function e(){n||(n=!0,m?a.bind(c,{start:j,move:l,end:k,cancel:k}):c.on("mousedown",g))}function f(){n&&(n=!1,m?a.unbind(c,{start:j,move:l,end:k,cancel:k}):(c.off("mousedown",g),c.off("mousemove",h),c.off("mouseout",i),c.off("mouseup",i)))}function g(a){a.preventDefault(),j({x:a.screenX,y:a.screenY}),c.on("mousemove",h),c.on("mouseup",i),c.on("mouseout",i)}function h(a){l({x:a.screenX,y:a.screenY})}function i(){c.off("mousemove",h),c.off("mouseout",i),c.off("mouseup",i),k()}function j(a){b.$apply(function(){b.active=!0});var c=b.trackPad;c.previousPoint=a}function k(a){b.trackPad.distancePoint={x:0,y:0,mx:0,my:0},b.$apply(function(){b.active=!1})}function l(a){var c=b.trackPad;c.distancePoint.mx=a.x-c.previousPoint.mx,c.distancePoint.my=a.y-c.previousPoint.my,c.previousPoint.mx=a.x,c.previousPoint.my=a.y,c.distancePoint.x=a.x-c.previousPoint.x,c.distancePoint.y=a.y-c.previousPoint.y,o=!0}var m="true"==d.touchEnabled,n=!1,o=!1;b.active=!1,b.trackPad={previousPoint:{x:0,y:0},distancePoint:{x:0,y:0,mx:0,my:0}},d.$observe("enabled",function(a){"true"==a?e():f()})}}}]).directive("imageOverlay",[function(){return{restrict:"E",link:function(a,b,c){function d(a){return a.charAt(0).toUpperCase()+a.slice(1)}void 0==a.imageOverlay&&(a.imageOverlay={}),a.imageOverlay["disable"+d(c.id)+"Image"]=function(){b.hasClass("hidden")||b.addClass("hidden")},a.imageOverlay["set"+d(c.id)+"Image"]=function(a,c,d){var e=!1,f={},g=b.hasClass("hidden");null!=a&&""!=a&&(f["background-image"]="url("+a+")",e=!0),c>=0&&(f.opacity=c,e=!0),void 0!=d&&(f["background-size"]=d,e=!0),e&&b.css(f),g&&void 0==d&&b.removeClass("hidden")}}}}]);var module=angular.module("app",["app.services","app.directives","app.controllers","ngRoute","ngCookies","ngTouch","ui.bootstrap","angular-progress-arc","FBAngular","angular-animation-frame","angular-slider","angular-scroll-indicator"]);module.config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"partials/main-menu.html",controller:"MenuCtrl"}).when("/project",{templateUrl:"partials/project.html",controller:"ProjectCtrl"}).when("/book",{templateUrl:"partials/book.html",controller:"BookCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode({enabled:!0,requireBase:!1})}]);